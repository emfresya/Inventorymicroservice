# Inventory Service

![–î–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞](https://raw.githubusercontent.com/emfresya/Inventorymicroservice/refs/heads/main/DataDiagram.svg)


### –¢–∞–±–ª–∏—Ü—ã:
categories
    category_id (PK, INT, AUTO_INCREMENT) ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏,
    name (VARCHAR) ‚Äî –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ,
    parent_id (FK ‚Üí categories.category_id) ‚Äî —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (NULL = –∫–æ—Ä–µ–Ω—å),
    path (VARCHAR) ‚Äî –ø—É—Ç—å –≤ –¥–µ—Ä–µ–≤–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, /1/5/23/) ‚Äî –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ–¥–¥–µ—Ä–µ–≤–∞,
    level (INT) ‚Äî —É—Ä–æ–≤–µ–Ω—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ (0 = –∫–æ—Ä–µ–Ω—å).
products
    product_id (PK, INT, AUTO_INCREMENT) ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç–æ–≤–∞—Ä–∞,
    sku (VARCHAR, UNIQUE) ‚Äî –∞—Ä—Ç–∏–∫—É–ª,
    name (VARCHAR) ‚Äî –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ,
    quantity (INT, CHECK ‚â• 0) ‚Äî –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ,
    price (NUMERIC(12,2), CHECK ‚â• 0) ‚Äî —Ü–µ–Ω–∞,
    category_id (FK ‚Üí categories.category_id) ‚Äî –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞,
    root_category_id (FK ‚Üí categories.category_id) ‚Äî –∫–æ—Ä–Ω–µ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤).
clients
    client_id (PK, INT, AUTO_INCREMENT) ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–ª–∏–µ–Ω—Ç–∞,
    name (VARCHAR) ‚Äî –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ,
    address (TEXT) ‚Äî –∞–¥—Ä–µ—Å,
    email, phone ‚Äî –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
    order_statuses
    status_id (PK, SMALLINT) ‚Äî ID —Å—Ç–∞—Ç—É—Å–∞,
    status_name (VARCHAR, UNIQUE) ‚Äî –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–Ω–æ–≤—ã–π", "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω", "–æ—Ç–º–µ–Ω—ë–Ω").
orders
    order_id (PK, INT, AUTO_INCREMENT) ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–∫–∞–∑–∞,
    client_id (FK ‚Üí clients.client_id) ‚Äî –∫–ª–∏–µ–Ω—Ç,
    status_id (FK ‚Üí order_statuses.status_id) ‚Äî —Å—Ç–∞—Ç—É—Å,
    order_date (TIMESTAMP) ‚Äî –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è,
    total_sum (NUMERIC(14,2)) ‚Äî —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞.
order_items
    order_item_id (PK, INT, AUTO_INCREMENT) ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–∑–∏—Ü–∏–∏,
    order_id (FK ‚Üí orders.order_id) ‚Äî –∑–∞–∫–∞–∑,
    product_id (FK ‚Üí products.product_id) ‚Äî —Ç–æ–≤–∞—Ä,
    quantity (INT, CHECK > 0) ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ,
    price_at_order (NUMERIC(12,2), CHECK ‚â• 0) ‚Äî —Ü–µ–Ω–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–∫–∞–∑–∞.
monthly_product_sales (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–æ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞)
    year_month (CHAR(7)) ‚Äî –º–µ—Å—è—Ü (–Ω–∞–ø—Ä–∏–º–µ—Ä, "2024-09"),
    product_id (FK ‚Üí products.product_id),
    root_category_id (FK ‚Üí categories.category_id),
    total_quantity (INT) ‚Äî –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω–æ–≥–æ –∑–∞ –º–µ—Å—è—Ü,
    last_updated (TIMESTAMP) ‚Äî –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
aggregation_metadata (—Å–ª—É–∂–µ–±–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞)
    job_name (TEXT, PK) ‚Äî –∏–º—è –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "monthly_sales"),
    last_processed_order_date (TIMESTAMP) ‚Äî –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤.
### –¢–æ–ø-5 —Å–∞–º—ã—Ö –ø–æ–∫—É–ø–∞–µ–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü (–Ω–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

CREATE OR REPLACE VIEW top_5_products_last_month AS
SELECT
    p.name AS "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
    root_cat.name AS "–ö–∞—Ç–µ–≥–æ—Ä–∏—è 1-–≥–æ —É—Ä–æ–≤–Ω—è",
    SUM(oi.quantity) AS "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —à—Ç—É–∫"
FROM
    order_items oi
JOIN
    orders o ON oi.order_id = o.order_id
JOIN
    products p ON oi.product_id = p.product_id
JOIN
    categories cat ON p.category_id = cat.category_id
JOIN
    categories root_cat ON root_cat.category_id = 
        CAST(
            split_part(trim(leading '/' from trim(trailing '/' from cat.path)), '/', 1)
            AS INTEGER
        )
WHERE
    o.order_date >= date_trunc('month', CURRENT_DATE)
    AND o.order_date < date_trunc('month', CURRENT_DATE) + INTERVAL '1 month'
    AND o.status_id IN (2, 3, 4, 5, 6)
GROUP BY
    p.product_id,
    p.name,
    root_cat.name
ORDER BY
    "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —à—Ç—É–∫" DESC
LIMIT 5;
###

### –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ 

1. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ split_part
–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å ‚Üí full scan (categories) –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ ‚Üí O(N^2)
2. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Å—ã—Ä—ã–º –¥–∞–Ω–Ω—ã–º order_items
–ü—Ä–∏ 300 000+ –ø–æ–∑–∏—Ü–∏–π –≤ –º–µ—Å—è—Ü ‚Üí —Ç—è–∂—ë–ª–∞—è GROUP BY –∏ SUM, —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU –∏ I/O (–≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç 1 –¥–æ 10 —Å–µ–∫)
3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–∫—Ä—ã–≤–∞—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
–§–∏–ª—å—Ç—Ä –ø–æ order_date + status_id ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ orders
4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
–ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—è–∂—ë–ª—ã–π –∑–∞–ø—Ä–æ—Å ‚Üí –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è
5. –ù–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
–í—Ä–µ–º—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Ç—ë—Ç –ª–∏–Ω–µ–π–Ω–æ —Å –æ–±—ä—ë–º–æ–º –¥–∞–Ω–Ω—ã—Ö
###

### 2.3.2 –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ root_category_id –≤ products - —É–±–∏—Ä–∞–µ—Ç split_part ‚Üí JOIN –ø–æ –∏–Ω–¥–µ–∫—Å—É ‚Üí O(1).
2. –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ monthly_product_sales —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –ø–æ—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏, –æ–±–Ω–æ–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ Celery, –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ —á—Ç–µ–Ω–∏–µ –∏–¥–µ—Ç –Ω–µ –º–∏–ª–ª–∏–æ–Ω–∞–º–∏ —Å—Ç—Ä–æ–∫, –∞ 100 —Å—Ç—Ä–æ–∫ –∫ –ø—Ä–∏–º–µ—Ä—É —Ä–∞–∑ –≤ —á–∞—Å.
3. –°–¥–µ–ª–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∑–∞–∫–∞–∑–æ–≤
4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î, –∏ —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à–µ, —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –æ–∫–æ–ª–æ–Ω—É–ª–µ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î –∏ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –∏–∑ –∫—ç—à–∞.
5. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å—Ç—Ä–æ–∫ > 1 –º–ª–Ω.
###

###
–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤–Ω–æ—Å—è—Ç —É–º–µ—Ä–µ–Ω–Ω—É—é –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∞–≥—Ä–µ–≥–∞—Ü–∏—é
###

### SQL-–∑–∞–ø—Ä–æ—Å(–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

SELECT
    products.name AS "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
    categories.name AS "–ö–∞—Ç–µ–≥–æ—Ä–∏—è 1-–≥–æ —É—Ä–æ–≤–Ω—è",
    monthly_product_sales.total_quantity AS "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —à—Ç—É–∫"
FROM
    monthly_product_sales
JOIN products ON monthly_product_sales.product_id = products.product_id
JOIN categories ON monthly_product_sales.root_category_id = categories.category_id
WHERE
    monthly_product_sales.year_month = to_char(CURRENT_DATE, 'YYYY-MM')
ORDER BY
    monthly_product_sales.total_quantity DESC
LIMIT 5;

###

### 3. REST API –Ω–∞ FastAPI (Python), —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –º–µ—Ç–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑.

üõ†Ô∏è –°—Ç–µ–∫:
    Python 3.11
    FastAPI ‚Äî —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
    SQLAlchemy Core ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –ë–î (–±–µ–∑ ORM-–º–æ–¥–µ–ª–µ–π)
    PostgreSQL ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ë–î
    Redis ‚Äî –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    Celery ‚Äî —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
    Docker / Docker Compose ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
    Flyway ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏

### üìå –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
POST /orders/{order_id}/items
JSON:
json
{
  "product_id": 1,
  "quantity": 2
}
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    –ó–∞–∫–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å—Ç–∞—Ç—É—Å = "–Ω–æ–≤—ã–π",
    –¢–æ–≤–∞—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç,
    –ï—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥–µ,
    –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –µ—Å—Ç—å –≤ –∑–∞–∫–∞–∑–µ ‚Üí —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ,
    –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é,
## JSON:
{
  "order_item_id": 5,
  "order_id": 10,
  "product_id": 1,
  "quantity": 3,
  "price_at_order": 79990.0
}

### üìå –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
GET /orders/top5
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¢–û–ü-5 —Å–∞–º—ã—Ö –ø–æ–∫—É–ø–∞–µ–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü,
    –ß–∏—Ç–∞–µ—Ç –∏–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –ø–æ—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ (monthly_product_sales),
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Redis-–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (15 –º–∏–Ω—É—Ç),

## JSON:
[
  {
    "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞": "Samsung Galaxy S24",
    "–ö–∞—Ç–µ–≥–æ—Ä–∏—è 1-–≥–æ —É—Ä–æ–≤–Ω—è": "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞",
    "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —à—Ç—É–∫": 10
  }
]

### üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
Flyway ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è–º–∏,
Celery + Redis ‚Äî —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ (—Ä–∞–∑ –≤ —á–∞—Å),
SQLAlchemy Core ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ö–µ–º–µ,
–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —É–º–µ–Ω—å—à–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î,
Docker Compose ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ—Å—å —Å—Ç–µ–∫ (PostgreSQL, Redis, FastAPI, Celery).

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ó–∞–ø—É—Å–∫: docker-compose up -d,
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API: http://localhost:8000/docs,
–û—Ç—á—ë—Ç: http://localhost:8000/top5,
–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: POST http://localhost:8000/orders/1/items,
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Celery: http://localhost:5555.
